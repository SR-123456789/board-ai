generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User model for application-specific data linked to Supabase Auth
model User {
  id        String   @id // Supabase Auth ID
  email     String   @unique
  plan      String   @default("free") // "free", "pro", "plus", "admin", "vip"
  tokenUsage Int     @default(0) // Logic to reset monthly
  lastResetDate DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rooms     Room[]
}

// Configuration for Plans
model PlanConfig {
  plan        String  @id
  monthlyLimit Int     // -1 for unlimited, 100000 for free
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Room represents a workspace containing board and chat
model Room {
  id        String   @id @default(uuid())
  userId    String?  // Nullable for non-logged-in users until migration? Or force login?
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Parent-child relationship for copied rooms
  parentId  String?
  parent    Room?    @relation("RoomHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Room[]   @relation("RoomHierarchy")
  
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  board     Board?
  messages  Message[]
  managedState ManagedState?
}

// Board data stores nodes in JSONB
model Board {
  id        String   @id @default(uuid())
  roomId    String   @unique
  nodes     Json     @default("[]") // Array of BoardNode
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
}

// Chat messages
model Message {
  id        String   @id @default(uuid())
  roomId    String
  role      String   // "user" or "assistant"
  content   String
  parts     Json?    // For multimodal or structured parts
  chatTurnId String? // To link with operations
  createdAt DateTime @default(now())

  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
}

// State for Managed Mode
model ManagedState {
  id        String   @id @default(uuid())
  roomId    String   @unique
  phase     String   @default("hearing_level")
  roadmap   Json?    // Detailed roadmap structure
  currentUnitIndex Int @default(0)
  currentSectionIndex Int @default(0)
  hearingData Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
}
